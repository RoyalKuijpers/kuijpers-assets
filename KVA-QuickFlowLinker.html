<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Kuijpers ASML - Flow Dashboard</title>

        <script type="module" src="https://unpkg.com/@fluentui/web-components"></script>

        <style>
            /* 1. Global Reset & Box Sizing */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }

            :root {
                /* Light Mode Defaults */
                --status-active: #0b6a0b;
                --status-inactive: #505050;
                --status-poison: #a80000;
                --poison-bg: rgba(168, 0, 0, 0.05);
                --poison-border: rgba(168, 0, 0, 0.2);
            }

            /* Dark Mode Overrides */
            body.theme-dark {
                --status-active: #6CCB5F;
                --status-inactive: #E0E0E0;
                --status-poison: #FF99A4;
                --poison-bg: rgba(255, 153, 164, 0.15);
                --poison-border: rgba(255, 153, 164, 0.3);
            }

            body {
                background-color: var(--neutral-layer-4);
                color: var(--neutral-foreground-rest);
                font-family: 'Segoe UI', sans-serif;
                margin: 0;
                padding: 0;
                height: 100vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* 2. Main Layout */
            .app-container {
                flex: 1;
                width: 100%;
                max-width: 1600px;
                margin: 0 auto;
                padding: 20px;
                overflow-y: auto;
                position: relative;
            }

            @media (min-width: 768px) {
                .app-container {
                    padding: 40px;
                }
            }

            /* 3. Header */
            .header {
                display: flex;
                flex-direction: column;
                gap: 20px;
                margin-bottom: 32px;
                padding-bottom: 20px;
                border-bottom: 1px solid var(--neutral-stroke-divider-rest);
            }

            @media (min-width: 1024px) {
                .header {
                    flex-direction: row;
                    justify-content: space-between;
                    align-items: flex-end;
                }
            }

            .header-title h1 {
                margin: 0;
                font-size: 24px;
                font-weight: 700;
                color: var(--neutral-foreground-rest);
            }

            .header-title p {
                margin: 4px 0 0 0;
                color: var(--neutral-foreground-2);
                font-size: 15px;
                font-weight: 500;
            }

            /* Controls */
            .header-controls {
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
                align-items: center;
                width: 100%;
            }

            @media (min-width: 1024px) {
                .header-controls {
                    width: auto;
                }
            }

            fluent-text-field {
                flex: 1 1 100%;
                min-width: 200px;
            }

            fluent-select {
                flex: 1 1 auto;
                min-width: 160px;
            }

            @media (min-width: 600px) {
                fluent-text-field {
                    flex: 0 1 300px;
                }
            }

            /* 4. Grid */
            .view-section {
                display: none;
                animation: fadeIn 0.3s ease;
            }

            .view-section.active {
                display: block;
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }

                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .flow-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 24px;
                padding-bottom: 40px;
            }

            /* 5. Cards */
            fluent-card {
                padding: 0;
                height: 100%;
                display: flex;
                flex-direction: column;
                border-radius: 8px;
                border: 1px solid var(--neutral-stroke-layer-rest);
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            fluent-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            }

            .card-body {
                padding: 20px;
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .card-top-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 16px;
            }

            .meta-container {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 12px;
                font-weight: 600;
            }

            .live-indicator {
                color: var(--status-poison);
                font-weight: 800;
                letter-spacing: 0.5px;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .live-pulse {
                width: 8px;
                height: 8px;
                background-color: var(--status-poison);
                border-radius: 50%;
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% {
                    opacity: 1;
                }

                50% {
                    opacity: 0.4;
                }

                100% {
                    opacity: 1;
                }
            }

            .meta-divider {
                width: 1px;
                height: 14px;
                background-color: var(--neutral-stroke-strong-rest);
            }

            .meta-env {
                color: var(--neutral-foreground-2);
            }

            .flow-title {
                font-size: 18px;
                font-weight: 700;
                line-height: 1.4;
                margin-bottom: 16px;
                color: var(--neutral-foreground-rest);
                display: -webkit-box;
                -webkit-line-clamp: 3;
                line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .status-placeholder {
                margin-top: auto;
                font-size: 12px;
                line-height: 1.6;
                color: var(--neutral-foreground-rest);
                background: var(--neutral-layer-3);
                padding: 10px;
                border-radius: 4px;
                font-family: 'Segoe UI Mono', monospace;
                border: 1px solid var(--neutral-stroke-divider-rest);
            }

            .card-footer {
                padding: 16px 20px;
                background-color: var(--neutral-layer-2);
                border-top: 1px solid var(--neutral-stroke-divider-rest);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .status-pill {
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                font-weight: 600;
                color: var(--neutral-foreground-rest);
            }

            .dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background-color: var(--neutral-foreground-hint);
                border: 1px solid rgba(0, 0, 0, 0.1);
            }

            .dot.active {
                background-color: var(--status-active);
                box-shadow: 0 0 0 2px rgba(16, 124, 16, 0.2);
            }

            .dot.inactive {
                background-color: var(--status-inactive);
            }

            .actions {
                display: flex;
                gap: 8px;
            }

            /* Poison Card */
            .poison-card {
                border-left: 6px solid var(--status-poison);
            }

            .poison-card .card-body {
                background: linear-gradient(to bottom right, var(--poison-bg), transparent);
            }

            .poison-card .status-placeholder {
                color: var(--status-poison);
                background: var(--poison-bg);
                font-weight: bold;
                border-color: var(--poison-border);
            }

            /* App Icon Utility */
            app-icon {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                vertical-align: middle;
                fill: currentColor;
            }

            fluent-button app-icon {
                width: 16px;
                height: 16px;
                margin-right: 6px;
            }

            /* Settings Table */
            .settings-toolbar {
                display: flex;
                gap: 12px;
                margin-bottom: 20px;
                padding: 16px;
                background: var(--neutral-layer-2);
                border-radius: 8px;
                border: 1px solid var(--neutral-stroke-layer-rest);
                flex-wrap: wrap;
            }

            .settings-table-container {
                overflow-x: auto;
                border: 1px solid var(--neutral-stroke-layer-rest);
                border-radius: 8px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                min-width: 900px;
                background: var(--neutral-layer-1);
            }

            th,
            td {
                text-align: left;
                padding: 12px 16px;
                border-bottom: 1px solid var(--neutral-stroke-divider-rest);
                vertical-align: middle;
            }

            th {
                background: var(--neutral-layer-2);
                font-weight: 600;
            }

            .status-cell {
                font-weight: 600;
            }

            .status-cell.Active {
                color: var(--status-active);
            }

            .status-cell.Inactive {
                color: var(--status-inactive);
            }

            .sub-text {
                font-size: 11px;
                color: var(--neutral-foreground-2);
                font-family: monospace;
                display: block;
                margin-top: 4px;
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                visibility: hidden;
                opacity: 0;
                transition: 0.2s;
            }

            .modal-overlay.open {
                visibility: visible;
                opacity: 1;
            }

            .modal {
                background: var(--neutral-layer-1);
                width: 100%;
                max-width: 550px;
                padding: 24px;
                border-radius: 8px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                border: 1px solid var(--neutral-stroke-layer-rest);
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal-header {
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 16px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-group label {
                display: block;
                margin-bottom: 6px;
                font-weight: 600;
                font-size: 13px;
                color: var(--neutral-foreground-rest);
            }

            .modal-actions {
                display: flex;
                justify-content: flex-end;
                gap: 12px;
                margin-top: 24px;
            }

            /* Category Editor */
            .category-editor {
                background: var(--neutral-layer-2);
                padding: 16px;
                border-radius: 6px;
                border: 1px dashed var(--neutral-stroke-strong-rest);
                margin-top: 8px;
                display: none;
            }

            .category-editor.open {
                display: block;
            }

            .form-row {
                display: flex;
                gap: 12px;
            }

            /* Authentication Overlay */
            .auth-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: var(--neutral-layer-1);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            }

            .auth-overlay.hidden {
                display: none;
            }

            .auth-container {
                background: var(--neutral-layer-2);
                padding: 40px;
                border-radius: 8px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                max-width: 500px;
                width: 90%;
            }

            .auth-container h2 {
                margin: 0 0 12px 0;
                color: var(--neutral-foreground-rest);
                font-size: 24px;
            }

            .auth-container p {
                margin: 0 0 24px 0;
                color: var(--neutral-foreground-2);
                font-size: 14px;
                line-height: 1.5;
            }

            .auth-error {
                background: rgba(168, 0, 0, 0.1);
                border: 1px solid rgba(168, 0, 0, 0.3);
                color: var(--status-poison);
                padding: 12px;
                border-radius: 4px;
                margin-bottom: 16px;
                display: none;
            }

            .auth-error.visible {
                display: block;
            }

            .auth-form-group {
                margin-bottom: 20px;
            }

            .auth-form-group label {
                display: block;
                margin-bottom: 8px;
                color: var(--neutral-foreground-rest);
                font-weight: 600;
            }

            .auth-actions {
                display: flex;
                gap: 12px;
                margin-top: 24px;
            }

            .logout-button {
                margin-left: 12px;
            }
        </style>
    </head>

    <body>

        <!-- Authentication Overlay -->
        <div class="auth-overlay" id="authOverlay">
            <div class="auth-container">
                <h2>üîê Authentication Required</h2>
                <p>This page requires a GitHub Personal Access Token (PAT) to access. Please enter your token below.</p>
                
                <div class="auth-error" id="authError"></div>

                <div class="auth-form-group">
                    <label for="githubToken">GitHub Personal Access Token</label>
                    <fluent-text-field 
                        id="githubToken" 
                        type="password" 
                        placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                        style="width: 100%">
                    </fluent-text-field>
                    <p style="margin-top: 8px; font-size: 12px; color: var(--neutral-foreground-2);">
                        Need a token? <a href="https://github.com/settings/tokens/new" target="_blank" style="color: var(--accent-fill-rest);">Create one here</a> (no special scopes required for basic access)
                    </p>
                </div>

                <div class="auth-actions">
                    <fluent-button appearance="accent" onclick="authenticate()" id="authButton">
                        Authenticate
                    </fluent-button>
                </div>
            </div>
        </div>

        <div class="app-container">

            <header class="header">
                <div class="header-title">
                    <h1>My Flows Dashboard</h1>
                    <p>Direct Access Portal ‚Ä¢ Kuijpers Klantvestiging ASML</p>
                </div>

                <div class="header-controls">
                    <div id="dashboardControls" style="display:flex; gap:12px; align-items:center;">
                        <fluent-text-field id="searchBox" placeholder="Filter flows..." oninput="app.filter()">
                            <app-icon slot="start" name="search" style="width:16px; margin-top:4px;"></app-icon>
                        </fluent-text-field>

                        <fluent-select id="sortBox" onchange="app.sort()">
                            <fluent-option value="name">Sort: Name</fluent-option>
                            <fluent-option value="category">Sort: Category</fluent-option>
                            <fluent-option value="status">Sort: Status</fluent-option>
                        </fluent-select>
                    </div>

                    <fluent-button appearance="neutral" onclick="app.toggleView()">
                        <app-icon name="tool" id="viewIcon"></app-icon> <span id="viewText">Settings</span>
                    </fluent-button>

                    <fluent-button appearance="outline" onclick="logout()" class="logout-button">
                        Logout
                    </fluent-button>

                    <fluent-switch id="themeSwitch" onchange="app.toggleTheme()">
                        <span slot="checked-message">Dark</span>
                        <span slot="unchecked-message">Light</span>
                    </fluent-switch>
                </div>
            </header>

            <main class="view-section active" id="dashboardView">
                <div class="flow-grid" id="gridTarget"></div>
            </main>

            <main class="view-section" id="settingsView">
                <div class="settings-toolbar">
                    <fluent-button appearance="accent" onclick="app.openModal()">
                        <app-icon name="plus"></app-icon> Add New Flow
                    </fluent-button>
                    <fluent-button appearance="outline" onclick="app.exportSettings()">
                        <app-icon name="download"></app-icon> Export JSON
                    </fluent-button>
                    <fluent-button appearance="outline" onclick="document.getElementById('importFile').click()">
                        <app-icon name="upload"></app-icon> Import JSON
                    </fluent-button>
                    <input type="file" id="importFile" style="display:none" accept=".json"
                        onchange="app.importSettings(this)">

                    <div style="margin-left:auto;">
                        <fluent-button appearance="stealth" onclick="app.resetDefaults()"
                            style="color:var(--status-poison);">
                            Reset to Defaults
                        </fluent-button>
                    </div>
                </div>

                <div class="settings-table-container">
                    <table id="settingsTable">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Display Name / Raw Name</th>
                                <th>Category</th>
                                <th>Flow ID (GUID)</th>
                                <th>Type</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </main>
        </div>

        <!-- MODAL -->
        <div class="modal-overlay" id="modalOverlay">
            <div class="modal">
                <div class="modal-header" id="modalTitle">Edit Flow</div>
                <input type="hidden" id="editIndex">

                <div class="form-group">
                    <label>Flow Name (Raw)</label>
                    <fluent-text-field id="inputName" style="width:100%"></fluent-text-field>
                    <span class="sub-text">This matches the name in Power Automate. Category tags like [Sync] will be
                        parsed.</span>
                </div>

                <div class="form-group">
                    <label>Flow ID (GUID)</label>
                    <fluent-text-field id="inputId" style="width:100%"></fluent-text-field>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <fluent-select id="inputCategory" style="width:100%" onchange="app.handleCategoryChange()">
                        <!-- Populated via JS -->
                    </fluent-select>

                    <div id="categoryEditor" class="category-editor">
                        <label style="color:var(--neutral-foreground-rest)">New / Custom Category Details</label>
                        <div class="form-group">
                            <fluent-text-field id="catNewName" placeholder="Category Name (e.g. HR)"
                                style="width:100%"></fluent-text-field>
                        </div>
                        <div class="form-row">
                            <div style="flex:1">
                                <label>Color</label>
                                <!-- UPDATED: Using valid Fluent UI color values -->
                                <fluent-select id="catNewColor" style="width:100%">
                                    <fluent-option value="neutral">Neutral (Grey)</fluent-option>
                                    <fluent-option value="brand">Brand (Blue)</fluent-option>
                                    <fluent-option value="success">Success (Green)</fluent-option>
                                    <fluent-option value="warning">Warning (Orange)</fluent-option>
                                    <fluent-option value="error">Error (Red)</fluent-option>
                                </fluent-select>
                            </div>
                            <div style="flex:1">
                                <label>Icon</label>
                                <fluent-select id="catNewIcon" style="width:100%">
                                    <fluent-option value="tool">Tool</fluent-option>
                                    <fluent-option value="shield">Shield</fluent-option>
                                    <fluent-option value="mail">Mail</fluent-option>
                                    <fluent-option value="sync">Sync</fluent-option>
                                    <fluent-option value="badge">Badge</fluent-option>
                                    <fluent-option value="flask">Flask</fluent-option>
                                    <fluent-option value="star">Star</fluent-option>
                                    <fluent-option value="heart">Heart</fluent-option>
                                    <fluent-option value="flag">Flag</fluent-option>
                                </fluent-select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label>Status</label>
                        <fluent-select id="inputStatus" style="width:100%">
                            <fluent-option value="Active">Active</fluent-option>
                            <fluent-option value="Inactive">Inactive</fluent-option>
                        </fluent-select>
                    </div>
                    <div class="form-group" style="flex:1; align-self:flex-end;">
                        <fluent-switch id="inputPoison">
                            <span slot="checked-message">Poison Record</span>
                            <span slot="unchecked-message">Normal Flow</span>
                        </fluent-switch>
                    </div>
                </div>

                <div class="modal-actions">
                    <fluent-button appearance="outline" onclick="app.closeModal()">Cancel</fluent-button>
                    <fluent-button appearance="accent" onclick="app.saveFlow()">Save Changes</fluent-button>
                </div>
            </div>
        </div>

        <script type="module">
            import {
                provideFluentDesignSystem,
                fluentCard, fluentButton, fluentTextField, fluentSelect, fluentOption, fluentBadge, fluentSwitch,
                baseLayerLuminance, StandardLuminance
            } from "https://unpkg.com/@fluentui/web-components";

            provideFluentDesignSystem().register(
                fluentCard(), fluentButton(), fluentTextField(), fluentSelect(), fluentOption(), fluentBadge(), fluentSwitch()
            );

            const ICON_PATHS = {
                search: "M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z",
                edit: "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",
                open: "M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z",
                plus: "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",
                tool: "M22.7 19l-9.1-9.1c.9-2.6.4-5.5-1.3-7.2-2.7-2.7-7.1-2.7-9.8 0s-2.7 7.1 0 9.8c1.7 1.7 4.6 2.2 7.2 1.3l9.1 9.1c.4.4 1 .4 1.4 0l2.5-2.5c.5-.4.5-1 0-1.4z",
                download: "M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z",
                upload: "M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z",
                trash: "M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z",
                shield: "M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z",
                mail: "M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z",
                sync: "M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z",
                badge: "M17 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z",
                flask: "M14 16h-4v-1c0-.55.45-1 1-1h2c.55 0 1 .45 1 1v1zm3.94-6l-1.72-3.45c-.27-.54-.23-1.18.11-1.68l.27-.47C16.89 3.86 16.51 3 15.96 3H8.04c-.55 0-.93.86-.64 1.4l.27.47c.34.51.38 1.14.11 1.68L6.06 10c-1.14 2.28-.02 5 2.53 5h6.82c2.55 0 3.67-2.72 2.53-5z",
                star: "M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z",
                heart: "M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z",
                flag: "M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"
            };

            class AppIcon extends HTMLElement {
                connectedCallback() {
                    const name = this.getAttribute('name');
                    const path = ICON_PATHS[name] || ICON_PATHS.tool;
                    this.innerHTML = `<svg viewBox="0 0 24 24" style="width:100%; height:100%; display:block;">${path}</svg>`;
                }
            }
            customElements.define('app-icon', AppIcon);

            const DEFAULT_CONFIG = {
                envId: "1bc86305-ce73-ed78-b941-a1f23b191d59",
                envName: "Kuijpers Klantvestiging ASML"
            };

            const DEFAULT_FLOWS = [
                { name: "kvadev_PhishingHandler", id: "1ae4c856-4299-4c17-9103-625866164741", poison: true, status: "Inactive" },
                { name: "üì¨[Mail Automation] Update CRE Maps to Sharepoint", id: "9102944d-5dda-f011-8544-6045bd9deacb", status: "Active" },
                { name: "üîÑÔ∏è[Sync]üìöMarketing & Communicatie ‚û°Ô∏èKVA üìöHuisstijl", id: "7b2c78db-2d76-f011-b4cb-6045bdf36e69", status: "Active" },
                { name: "üîÑÔ∏è[Sync-Delete]üìöMarketing & Communicatie ‚û°Ô∏èKVA üìöHuisstijl", id: "78eeb438-9176-f011-b4cb-6045bdf36e69", status: "Active" },
                { name: "üîë[Security-related Flows] Sync Users Projectenschijf ASML to SharePoint Site KVA Security Group", id: "7923b0cc-686c-f011-b4cc-6045bdf36e69", status: "Active" },
                { name: "üß™[TESTFLOW] When email arrives copy or replace file in doc library with mail attached file", id: "1f727999-7a6c-f011-b4cc-6045bdf36e69", status: "Active" },
                { name: "üß∞[Maintenance] Manual triggered flow to batch delete sharepoint list that contains >100.000 items", id: "8d4751f7-edb7-f011-bbd3-7c1e5273c78c", status: "Active" },
                { name: "ü™™[Badgeregistratie] Als het aanmeldformulier badge aanvraag is ingevuld verstuur de welkomstmail", id: "6e8905cc-83c5-f011-bbd3-6045bd9deacb", status: "Active" },
                { name: "ü™™[Badgeregistratie] Als het aanmeldformulier bezoeker is ingevuld verstuur een mail om de bezoeker", id: "f2ec7bea-a272-f011-b4cc-6045bdf36e69", status: "Active" },
                { name: "ü™™[Badgeregistratie] Attach Badge Approved Email from CRE to User in Badge-List", id: "e0babcfb-865a-f011-bec2-000d3a3a8324", status: "Active" },
                { name: "ü™™[Badgeregistratie] Goedkeuringsstroom - Aanvraag toegangspas ASML", id: "dedd94cb-9872-f011-b4cc-000d3a44bc39", status: "Active" },
                { name: "ü™™[Badgeregistratie] Stuur een e-mail als het training aanvraag formulier is ingevuld", id: "cbfc1adf-7a6c-f011-b4cb-000d3a4425aa", status: "Inactive" },
                { name: "ü™™[Badgeregistratie] Update ASML EHS Trainingsdata (Dagelijks vanuit ontvangen email)", id: "579cc02b-ecac-ef11-b8e8-6045bd94ca6c", status: "Active" },
                { name: "ü™™[Badgeregistratie] Update EHS Trainingsdata op Badgeregistratielijst Sharepoint", id: "6abf458a-a04a-f011-877a-7c1e525da2d9", status: "Active" },
                { name: "ü™≤[TESTFLOW] Send HTML Files From OneDrive Folder to E-Mail", id: "13a14d03-ec6e-f011-b4cc-000d3a44bc39", status: "Active" },
                { name: "ü™≤[TESTFLOW] List Azure Applications and Owners", id: "7c9f089a-3c18-b57c-1dba-acdc311bc7fd", status: "Active" },
                { name: "ü™≤[TESTFLOW] Office 365 Users", id: "368b8bf3-e964-f011-bec3-000d3a38a2bc", status: "Active" }
            ];

            // FIXED: Categories now use standard Fluent UI color values
            const DEFAULT_CATEGORIES = {
                "Security": { icon: "shield", color: "success" },
                "Mail Automation": { icon: "mail", color: "brand" },
                "Sync": { icon: "sync", color: "brand" },
                "Sync-Delete": { icon: "sync", color: "error" },
                "Badgeregistratie": { icon: "badge", color: "warning" },
                "TESTFLOW": { icon: "flask", color: "neutral" },
                "Maintenance": { icon: "tool", color: "error" },
                "General": { icon: "tool", color: "neutral" }
            };

            class FlowDashboard {
                constructor() {
                    // IMPORTANT: Load state, then ensure defaults exist
                    this.state = this.loadState();
                    this.isSettingsView = false;
                }

                init() {
                    this.initTheme();
                    this.render();
                }

                loadState() {
                    const stored = localStorage.getItem('asmlDashboardData_v2');
                    if (stored) {
                        const data = JSON.parse(stored);
                        // CRITICAL FIX: Merge missing properties if old data exists
                        if (!data.categories) data.categories = DEFAULT_CATEGORIES;
                        if (!data.flows) data.flows = DEFAULT_FLOWS;
                        return data;
                    }
                    return {
                        config: DEFAULT_CONFIG,
                        flows: DEFAULT_FLOWS,
                        categories: DEFAULT_CATEGORIES
                    };
                }

                saveState() {
                    localStorage.setItem('asmlDashboardData_v2', JSON.stringify(this.state));
                    this.render();
                }

                resetDefaults() {
                    if (confirm("Are you sure? This will wipe all custom settings.")) {
                        this.state = { config: DEFAULT_CONFIG, flows: DEFAULT_FLOWS, categories: DEFAULT_CATEGORIES };
                        this.saveState();
                    }
                }

                processFlow(f) {
                    if (f.status === 'On') f.status = 'Active';
                    if (f.status === 'Off') f.status = 'Inactive';

                    let category = "General";
                    let cleanTitle = f.name;

                    if (f.category && this.state.categories[f.category]) {
                        category = f.category;
                        cleanTitle = f.name;
                    }
                    else {
                        const match = f.name.match(/\[(.*?)\]\s*(.*)/);
                        if (match) {
                            const extracted = match[1].trim();
                            cleanTitle = match[2].trim();
                            if (this.state.categories[extracted]) {
                                category = extracted;
                            } else {
                                const lower = extracted.toLowerCase();
                                if (lower.includes('security')) category = "Security";
                                else if (lower.includes('mail')) category = "Mail Automation";
                                else if (lower.includes('badge')) category = "Badgeregistratie";
                                else if (lower.includes('sync')) category = "Sync";
                                else if (lower.includes('test')) category = "TESTFLOW";
                                else if (lower.includes('maint')) category = "Maintenance";
                            }
                        }
                    }

                    const catConfig = this.state.categories[category] || this.state.categories["General"];

                    return { ...f, derivedCat: category, derivedTitle: cleanTitle, meta: catConfig };
                }

                render() {
                    const processed = this.state.flows.map(f => this.processFlow(f));
                    const term = document.getElementById('searchBox')?.value.toLowerCase() || "";
                    const filtered = processed.filter(f =>
                        f.derivedTitle.toLowerCase().includes(term) ||
                        f.derivedCat.toLowerCase().includes(term)
                    );

                    const sortMode = document.getElementById('sortBox')?.value || "name";
                    filtered.sort((a, b) => {
                        if (a.poison) return -1;
                        if (b.poison) return 1;
                        if (sortMode === 'name') return a.derivedTitle.localeCompare(b.derivedTitle);
                        if (sortMode === 'category') return a.derivedCat.localeCompare(b.derivedCat);
                        if (sortMode === 'status') return (a.status || "").localeCompare(b.status || "");
                    });

                    document.getElementById('gridTarget').innerHTML = filtered.map(flow => this.createCardHTML(flow)).join('');

                    const tbody = document.querySelector('#settingsTable tbody');
                    tbody.innerHTML = processed.map((f, index) => {
                        const realIndex = this.state.flows.indexOf(this.state.flows.find(orig => orig.id === f.id));
                        return `
                    <tr>
                        <td class="status-cell ${f.status}">${f.status}</td>
                        <td>
                            <strong>${f.derivedTitle}</strong>
                            <span class="sub-text">${f.name}</span>
                        </td>
                        <td>
                            <fluent-badge appearance="accent" color="${f.meta.color}">
                                <app-icon name="${f.meta.icon}" style="margin-right:4px;width:10px"></app-icon> 
                                ${f.derivedCat}
                            </fluent-badge>
                        </td>
                        <td style="font-family:monospace; font-size:11px;">${f.id}</td>
                        <td>${f.poison ? '<span style="color:var(--status-poison); font-weight:bold">POISON</span>' : 'Standard'}</td>
                        <td>
                            <fluent-button appearance="outline" onclick="app.editFlow(${realIndex})">Edit</fluent-button>
                            <fluent-button appearance="stealth" onclick="app.deleteFlow(${realIndex})" style="color:var(--status-poison)">
                                <app-icon name="trash"></app-icon>
                            </fluent-button>
                        </td>
                    </tr>`;
                    }).join('');
                }

                createCardHTML(flow) {
                    const editUrl = `https://make.powerautomate.com/environments/${this.state.config.envId}/flows/${flow.id}/edit`;
                    const runUrl = `https://make.powerautomate.com/environments/${this.state.config.envId}/flows/${flow.id}/details`;

                    if (flow.poison) {
                        return `
                    <fluent-card class="poison-card">
                        <div class="card-body">
                            <div class="card-top-row">
                                <fluent-badge appearance="accent" color="error">POISON RECORD</fluent-badge>
                            </div>
                            <div class="flow-title">${flow.name}</div>
                            <div class="status-placeholder">CRITICAL ERROR: DO NOT OPEN</div>
                        </div>
                        <div class="card-footer">
                             <div class="status-pill" style="color:var(--status-poison)">Suspended</div>
                             <div class="actions">
                                <fluent-button appearance="outline" onclick="window.open('${editUrl}')">Debug</fluent-button>
                             </div>
                        </div>
                    </fluent-card>`;
                    }

                    return `
                <fluent-card>
                    <div class="card-body">
                        <div class="card-top-row">
                            <fluent-badge appearance="accent" color="${flow.meta.color}">
                                <app-icon name="${flow.meta.icon}" style="margin-right:4px; width:12px;"></app-icon> 
                                ${flow.derivedCat}
                            </fluent-badge>
                            
                            <div class="meta-container">
                                <span class="live-indicator"><div class="live-pulse"></div> LIVE</span>
                                <div class="meta-divider"></div>
                                <span class="meta-env">ASML</span>
                            </div>
                        </div>

                        <div class="flow-title" title="${flow.derivedTitle}">${flow.derivedTitle}</div>

                        <div class="status-placeholder">
                            STATUS: CONNECTED<br>
                            LAST RUN: IDLE
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="status-pill">
                            <span class="dot ${flow.status === 'Active' ? 'active' : 'inactive'}"></span>
                            ${flow.status}
                        </div>
                        <div class="actions">
                            <fluent-button appearance="outline" onclick="window.open('${editUrl}')">
                                <app-icon name="edit"></app-icon> Edit
                            </fluent-button>
                            <fluent-button appearance="accent" onclick="window.open('${runUrl}')">
                                <app-icon name="open"></app-icon> Details
                            </fluent-button>
                        </div>
                    </div>
                </fluent-card>`;
                }

                openModal() {
                    document.getElementById('modalOverlay').classList.add('open');
                    this.clearForm();
                    this.updateCategoryDropdown();
                    document.getElementById('modalTitle').textContent = "Add New Flow";
                }

                closeModal() {
                    document.getElementById('modalOverlay').classList.remove('open');
                }

                updateCategoryDropdown(selectedCat = "") {
                    const select = document.getElementById('inputCategory');
                    select.innerHTML = '';
                    Object.keys(this.state.categories).forEach(cat => {
                        const opt = document.createElement('fluent-option');
                        opt.value = cat;
                        opt.textContent = cat;
                        if (cat === selectedCat) opt.selected = true;
                        select.appendChild(opt);
                    });
                    const newOpt = document.createElement('fluent-option');
                    newOpt.value = "__NEW__";
                    newOpt.textContent = "+ Create New / Edit...";
                    select.appendChild(newOpt);
                }

                handleCategoryChange() {
                    const val = document.getElementById('inputCategory').value;
                    const editor = document.getElementById('categoryEditor');
                    if (val === "__NEW__") editor.classList.add('open');
                    else editor.classList.remove('open');
                }

                editFlow(index) {
                    const f = this.state.flows[index];
                    const derived = this.processFlow(f);

                    document.getElementById('editIndex').value = index;
                    document.getElementById('inputName').value = f.name;
                    document.getElementById('inputId').value = f.id;
                    document.getElementById('inputStatus').value = f.status;
                    document.getElementById('inputPoison').checked = f.poison || false;

                    const catToSelect = f.category || derived.derivedCat;
                    this.updateCategoryDropdown(catToSelect);

                    document.getElementById('modalTitle').textContent = "Edit Flow";
                    document.getElementById('modalOverlay').classList.add('open');
                    this.handleCategoryChange();
                }

                deleteFlow(index) {
                    if (confirm("Delete this flow?")) {
                        this.state.flows.splice(index, 1);
                        this.saveState();
                    }
                }

                saveFlow() {
                    const index = document.getElementById('editIndex').value;
                    let categorySelection = document.getElementById('inputCategory').value;

                    if (categorySelection === "__NEW__") {
                        const newName = document.getElementById('catNewName').value.trim();
                        const newColor = document.getElementById('catNewColor').value;
                        const newIcon = document.getElementById('catNewIcon').value;
                        if (!newName) { alert("Please enter a name for the new category"); return; }
                        this.state.categories[newName] = { icon: newIcon, color: newColor };
                        categorySelection = newName;
                    }

                    const newFlow = {
                        name: document.getElementById('inputName').value,
                        id: document.getElementById('inputId').value,
                        category: categorySelection,
                        status: document.getElementById('inputStatus').value,
                        poison: document.getElementById('inputPoison').checked
                    };

                    if (index === "") this.state.flows.push(newFlow);
                    else this.state.flows[parseInt(index)] = newFlow;

                    this.saveState();
                    this.closeModal();
                }

                clearForm() {
                    document.getElementById('editIndex').value = "";
                    document.getElementById('inputName').value = "";
                    document.getElementById('inputId').value = "";
                    document.getElementById('inputStatus').value = "Active";
                    document.getElementById('inputPoison').checked = false;
                    document.getElementById('catNewName').value = "";
                    document.getElementById('categoryEditor').classList.remove('open');
                }

                exportSettings() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state, null, 2));
                    const node = document.createElement('a');
                    node.href = dataStr;
                    node.download = "asml_dashboard_config.json";
                    document.body.appendChild(node);
                    node.click();
                    node.remove();
                }

                importSettings(input) {
                    const file = input.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            this.state = JSON.parse(e.target.result);
                            this.saveState();
                            alert("Configuration loaded!");
                        } catch (err) { alert("Error parsing JSON"); }
                    };
                    reader.readAsText(file);
                }

                toggleView() {
                    this.isSettingsView = !this.isSettingsView;
                    document.getElementById('dashboardView').classList.toggle('active', !this.isSettingsView);
                    document.getElementById('settingsView').classList.toggle('active', this.isSettingsView);
                    document.getElementById('dashboardControls').style.display = this.isSettingsView ? 'none' : 'flex';
                    document.getElementById('viewText').textContent = this.isSettingsView ? "Dashboard" : "Settings";
                }

                filter() { this.render(); }
                sort() { this.render(); }

                initTheme() {
                    const saved = localStorage.getItem('fluentTheme');
                    const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const isDark = saved === 'dark' || (!saved && sysDark);
                    if (document.getElementById('themeSwitch')) document.getElementById('themeSwitch').checked = isDark;
                    this.applyTheme(isDark);
                }
                toggleTheme() {
                    const isDark = document.getElementById('themeSwitch').checked;
                    this.applyTheme(isDark);
                    localStorage.setItem('fluentTheme', isDark ? 'dark' : 'light');
                }
                applyTheme(isDark) {
                    if (isDark) {
                        baseLayerLuminance.setValueFor(document.body, StandardLuminance.DarkMode);
                        document.body.classList.add('theme-dark');
                    } else {
                        baseLayerLuminance.setValueFor(document.body, StandardLuminance.LightMode);
                        document.body.classList.remove('theme-dark');
                    }
                }
            }

            const app = new FlowDashboard();
            window.app = app;
            app.init();
        </script>

        <script>
            // Authentication functions in global scope (non-module script)
            const AUTH_STORAGE_KEY = 'github_auth_token';

            window.authenticate = async function() {
                const tokenInput = document.getElementById('githubToken');
                const token = tokenInput.value.trim();
                const errorDiv = document.getElementById('authError');
                const authButton = document.getElementById('authButton');

                if (!token) {
                    showAuthError('Please enter a GitHub token.');
                    return;
                }

                // Disable button and show loading state
                authButton.textContent = 'Authenticating...';
                authButton.disabled = true;
                errorDiv.classList.remove('visible');

                try {
                    // Validate token by making a simple API call to GitHub
                    const response = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.ok) {
                        // Token is valid
                        sessionStorage.setItem(AUTH_STORAGE_KEY, token);
                        hideAuthOverlay();
                        tokenInput.value = ''; // Clear the input for security
                    } else if (response.status === 401) {
                        showAuthError('Invalid GitHub token. Please check your token and try again.');
                    } else if (response.status === 403) {
                        showAuthError('GitHub API rate limit exceeded or token lacks permissions.');
                    } else {
                        showAuthError(`Authentication failed: ${response.statusText}`);
                    }
                } catch (error) {
                    showAuthError(`Network error: ${error.message}. Please check your connection.`);
                } finally {
                    authButton.textContent = 'Authenticate';
                    authButton.disabled = false;
                }
            };

            function showAuthError(message) {
                const errorDiv = document.getElementById('authError');
                errorDiv.textContent = message;
                errorDiv.classList.add('visible');
            }

            function hideAuthOverlay() {
                document.getElementById('authOverlay').classList.add('hidden');
            }

            function showAuthOverlay() {
                document.getElementById('authOverlay').classList.remove('hidden');
            }

            window.logout = function() {
                if (confirm('Are you sure you want to logout?')) {
                    sessionStorage.removeItem(AUTH_STORAGE_KEY);
                    showAuthOverlay();
                }
            };

            function checkAuthentication() {
                const token = sessionStorage.getItem(AUTH_STORAGE_KEY);
                if (token) {
                    // User has a token stored, hide the auth overlay
                    hideAuthOverlay();
                } else {
                    // No token, show the auth overlay
                    showAuthOverlay();
                }
            }

            // Add Enter key support for authentication
            document.addEventListener('DOMContentLoaded', function() {
                const tokenInput = document.getElementById('githubToken');
                if (tokenInput) {
                    tokenInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            window.authenticate();
                        }
                    });
                }
                
                // Check authentication status on page load
                checkAuthentication();
            });
        </script>
    </body>

</html>